<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Location Notifier</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 50px auto;
        padding: 20px;
        background-color: #f4f7f6;
      }

      .container {
        background: white;
        border: 1px solid #ddd;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .header-actions {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 10px;
      }

      h1 {
        text-align: center;
        color: #333;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #555;
      }

      input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px;
        box-sizing: border-box;
      }

      .autocomplete-container {
        position: relative;
        display: flex;
        gap: 8px;
        width: 100%;
      }

      .autocomplete-input-wrapper {
        flex: 0 0 85%;
        position: relative;
      }

      .search-button {
        flex: 0 0 15%;
        padding: 10px 8px;
        background-color: #d2dc20;
        color: white;
        border: 1px solid #007bff;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .autocomplete-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ccc;
        border-top: none;
        border-radius: 0 0 4px 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
      }

      .autocomplete-item {
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }

      .autocomplete-item:hover {
        background-color: #f0f0f0;
      }

      button {
        width: 100%;
        padding: 12px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s;
        margin-bottom: 10px;
      }

      button:hover {
        background-color: #0056b3;
      }

      .btn-secondary {
        background-color: #28a745;
      }

      .btn-secondary:hover {
        background-color: #218838;
      }

      .btn-danger {
        background-color: #dc3545;
      }

      .btn-danger:hover {
        background-color: #c82333;
      }

      #logoutButton {
        width: auto;
        padding: 8px 15px;
        font-size: 14px;
      }

      .tracking-status {
        margin-top: 10px;
        padding: 10px;
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 4px;
        display: none;
        text-align: center;
        color: #155724;
      }

      .location-info {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 4px;
        display: none;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="header-actions">
        <button id="logoutButton" class="btn-danger">Logout</button>
      </div>

      <h1>Location Notifier</h1>

      <div class="form-group">
        <label for="locationInput">Enter Destination Location:</label>
        <div class="autocomplete-container">
          <div class="autocomplete-input-wrapper">
            <input
              type="text"
              id="locationInput"
              placeholder="Start typing location name..."
            />
            <div class="autocomplete-list" id="autocompleteList"></div>
          </div>
          <button id="searchButton" class="search-button">Search</button>
        </div>
      </div>

      <button id="getLocationButton" class="btn-secondary">
        Get My Location
      </button>
      <button id="startTrackingButton" class="btn-secondary">
        Start Location Tracking
      </button>
      <button id="stopTrackingButton" class="btn-danger" style="display: none">
        Stop Location Tracking
      </button>

      <div class="tracking-status" id="trackingStatus">
        Location tracking active - sending every 30 seconds
      </div>

      <div class="location-info" id="locationInfo">
        <p><strong>Your Current Location:</strong></p>
        <p>Latitude: <span id="latitude">-</span></p>
        <p>Longitude: <span id="longitude">-</span></p>
      </div>
    </div>

    <script>
      let locationInterval = null;
      let autoLogoutTimer = null;

      // 1. ACTIVE SESSION MANAGEMENT
      // Checks remaining time from server and sets a logout timer
      async function initializeSession() {
        try {
          const response = await fetch("/api/session_info");
          if (!response.ok) {
            window.location.href = "/static/login.html";
            return;
          }

          const data = await response.json();
          const remainingMs = data.remaining_seconds * 1000;

          console.log(
            `Logged in as: ${data.username}. Expiration in ${data.remaining_seconds}s`,
          );

          if (autoLogoutTimer) clearTimeout(autoLogoutTimer);

          autoLogoutTimer = setTimeout(() => {
            alert("Your session has expired. Please log in again.");
            window.location.href = "/static/login.html";
          }, remainingMs);
        } catch (error) {
          console.error("Session check failed:", error);
          window.location.href = "/static/login.html";
        }
      }

      // 2. RESPONSE HANDLER
      // Standardizes response checking for 401 Unauthorized errors
      async function handleResponse(response) {
        if (response.status === 401) {
          alert("Session expired. Please log in again.");
          window.location.href = "/static/login.html";
          return null;
        }
        return response.json();
      }

      // 3. LOGOUT BUTTON
      document
        .getElementById("logoutButton")
        .addEventListener("click", async () => {
          await fetch("/api/logout", { method: "POST" });
          window.location.href = "/static/login.html";
        });

      // 4. LOCATION TRACKING
      async function sendLocationToBackend(latitude, longitude) {
        try {
          const response = await fetch("/api/track_location", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              latitude: latitude,
              longitude: longitude,
              timestamp: new Date().toISOString(),
            }),
          });

          const data = await handleResponse(response);
          if (!data) return;

          if (data.status === "alert") {
            alert(data.message);
            stopLocationTracking();
          }
        } catch (error) {
          console.error("Error tracking location:", error);
        }
      }

      function startLocationTracking() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition((position) => {
            sendLocationToBackend(
              position.coords.latitude,
              position.coords.longitude,
            );
          });

          locationInterval = setInterval(() => {
            navigator.geolocation.getCurrentPosition(
              (position) =>
                sendLocationToBackend(
                  position.coords.latitude,
                  position.coords.longitude,
                ),
              (err) => console.error("Geolocation error:", err),
            );
          }, 30000);

          document.getElementById("startTrackingButton").style.display = "none";
          document.getElementById("stopTrackingButton").style.display = "block";
          document.getElementById("trackingStatus").style.display = "block";
        } else {
          alert("Geolocation not supported.");
        }
      }

      function stopLocationTracking() {
        if (locationInterval) {
          clearInterval(locationInterval);
          locationInterval = null;
          document.getElementById("startTrackingButton").style.display =
            "block";
          document.getElementById("stopTrackingButton").style.display = "none";
          document.getElementById("trackingStatus").style.display = "none";
        }
      }

      // 5. AUTOCOMPLETE & DESTINATION
      const locationInput = document.getElementById("locationInput");
      const autocompleteList = document.getElementById("autocompleteList");

      async function performAutocompleteSearch(query) {
        if (query.length < 2) return;
        try {
          const response = await fetch("/api/autocomplete_location", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ location_name: query }),
          });

          const data = await handleResponse(response);
          if (!data) return;

          const predictions = data.predictions || [];
          autocompleteList.innerHTML = "";
          predictions.forEach((prediction) => {
            const div = document.createElement("div");
            div.className = "autocomplete-item";
            div.textContent = prediction.description;
            div.onclick = () => {
              locationInput.value = prediction.description;
              autocompleteList.style.display = "none";
              setDestination(prediction.place_id);
            };
            autocompleteList.appendChild(div);
          });
          autocompleteList.style.display = predictions.length
            ? "block"
            : "none";
        } catch (error) {
          console.error("Autocomplete error:", error);
        }
      }

      async function setDestination(placeId) {
        try {
          const response = await fetch("/api/set_destination", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ place_id: placeId }),
          });

          const data = await handleResponse(response);
          if (data && data.status === "success") {
            alert("Destination set successfully! Tracking started.");
            startLocationTracking();
          }
        } catch (error) {
          console.error("Error setting destination:", error);
        }
      }

      // EVENT LISTENERS
      document.getElementById("startTrackingButton").onclick =
        startLocationTracking;
      document.getElementById("stopTrackingButton").onclick =
        stopLocationTracking;
      document.getElementById("searchButton").onclick = () =>
        performAutocompleteSearch(locationInput.value.trim());

      document.getElementById("getLocationButton").onclick = () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition((pos) => {
            document.getElementById("latitude").textContent =
              pos.coords.latitude.toFixed(6);
            document.getElementById("longitude").textContent =
              pos.coords.longitude.toFixed(6);
            document.getElementById("locationInfo").style.display = "block";
          });
        }
      };

      // Initialization
      initializeSession();
    </script>
  </body>
</html>
